<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Data Editor</title>
    <!-- 1. Load Tailwind CSS for styling --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a dark theme */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
        }
        .card {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.5rem;
        }
        .input-field {
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            color: #f3f4f6; /* gray-100 */
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .input-field:focus {
            outline: 2px solid #2563eb; /* blue-600 */
            border-color: #2563eb;
        }
        .label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #d1d5db; /* gray-300 */
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #2563eb; /* blue-600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .btn-secondary {
            background-color: #4b5563; /* gray-600 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #374151; /* gray-700 */
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }
        #drop-zone {
            border: 2px dashed #4b5563; /* gray-600 */
            border-radius: 0.5rem;
            padding: 4rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        #drop-zone.dragover {
            background-color: #374151; /* gray-700 */
            border-color: #2563eb; /* blue-600 */
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .tab-btn.active {
            color: #3b82f6; /* blue-500 */
            border-bottom-color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .list-item {
            cursor: pointer; /* Indicate clickable for editing */
            transition: background-color 0.2s;
        }
        .list-item:hover {
            background-color: #2d3748; /* Darker gray on hover */
        }
        .editing-mode-text {
            color: #fcd34d; /* Yellow-400 */
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        
        <!-- Header --><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-white">Team Data Editor</h1>
                <p class="text-lg text-gray-400">Load, edit, and save your `data.json` file.</p>
            </div>
            <button id="download-btn" class="btn btn-primary mt-4 sm:mt-0" style="display: none;">
                Save & Download data.json
            </button>
        </div>

        <!-- Message Bar --><div id="message-bar" class="p-4 mb-4 rounded-md text-center" style="display: none;"></div>

        <!-- Step 1: Drop Zone --><div id="drop-zone" class="card">
            <p class="text-xl font-medium text-gray-300">Drag & drop your `data.json` file here</p>
            <p class="text-gray-400">or click to select file</p>
            <input type="file" id="file-input" class="hidden" accept="application/json">
        </div>

        <!-- Step 2: Editor (Hidden by default) --><div id="editor-area" style="display: none;">
            
            <!-- Tab Navigation --><div class="border-b border-gray-700 mb-6">
                <nav class="flex -mb-px space-x-4" id="tabs">
                    <button class="tab-btn active" data-tab="general">General</button>
                    <button class="tab-btn" data-tab="members">Members</button>
                    <button class="tab-btn" data-tab="contests">Contests</button>
                    <button class="tab-btn" data-tab="writeups">Writeups</button>
                    <button class="tab-btn" data-tab="gallery">Gallery</button>
                </nav>
            </div>

            <!-- Tab Content --><div>
                <!-- General Tab --><div id="tab-general" class="tab-content active space-y-6">
                    <div class="card p-6">
                        <h2 class="text-2xl font-semibold mb-4 text-white">General Info</h2>
                        <form id="general-form" class="space-y-4">
                            <div>
                                <label for="teamName" class="label">Team Name</label>
                                <input type="text" id="teamName" class="input-field" placeholder="Your Team Name">
                            </div>
                            <div>
                                <label for="flagline" class="label">Flagline</label>
                                <input type="text" id="flagline" class="input-field" placeholder="your_team{flag}">
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Members Tab --><div id="tab-members" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6 lg:col-span-2">
                            <h2 class="text-2xl font-semibold mb-4 text-white">Current Members</h2>
                            <div id="members-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                <!-- Members will be injected here by JS --></div>
                        </div>
                        <div class="card p-6 lg:col-span-1">
                            <h2 class="text-2xl font-semibold mb-4 text-white">Add/Edit Member</h2>
                            <div id="member-editing-indicator" class="editing-mode-text" style="display:none;">
                                Editing: <span id="editing-member-name"></span>
                            </div>
                            <form id="add-member-form" class="space-y-4">
                                <input type="hidden" id="member-edit-index"> <!-- Hidden field for edit index --><div>
                                    <label for="member-name" class="label">Name</label>
                                    <input type="text" id="member-name" class="input-field" required>
                                </div>
                                <div>
                                    <label for="member-avatar" class="label">Avatar URL</label>
                                    <input type="text" id="member-avatar" class="input-field" placeholder="/images/members/name.png" required>
                                </div>
                                <div>
                                    <label for="member-moto" class="label">Moto</label>
                                    <input type="text" id="member-moto" class="input-field" required>
                                </div>
                                <div>
                                    <label for="member-tags" class="label">Tags (comma-separated)</label>
                                    <input type="text" id="member-tags" class="input-field" placeholder="Web, Pwn, Crypto" required>
                                </div>
                                <div>
                                    <label for="member-github" class="label">GitHub URL</label>
                                    <input type="url" id="member-github" class="input-field" placeholder="https://github.com/...">
                                </div>
                                <div>
                                    <label for="member-facebook" class="label">Facebook URL</label>
                                    <input type="url" id="member-facebook" class="input-field" placeholder="https://facebook.com/...">
                                </div>
                                <div>
                                    <label for="member-linkedin" class="label">LinkedIn URL</label>
                                    <input type="url" id="member-linkedin" class="input-field" placeholder="https://linkedin.com/in/...">
                                </div>
                                <button type="submit" id="add-member-btn" class="btn btn-primary w-full">Add Member</button>
                                <button type="button" id="cancel-edit-member-btn" class="btn btn-secondary w-full" style="display:none;">Cancel Edit</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Contests Tab --><div id="tab-contests" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6 lg:col-span-2">
                            <h2 class="text-2xl font-semibold mb-4 text-white">Current Contests</h2>
                            <div id="contests-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                <!-- Contests will be injected here by JS --></div>
                        </div>
                        <div class="card p-6 lg:col-span-1">
                            <h2 class="text-2xl font-semibold mb-4 text-white">Add/Edit Contest</h2>
                            <div id="contest-editing-indicator" class="editing-mode-text" style="display:none;">
                                Editing: <span id="editing-contest-name"></span>
                            </div>
                            <form id="add-contest-form" class="space-y-4">
                                <input type="hidden" id="contest-edit-index">
                                <div>
                                    <label for="contest-name" class="label">Name</label>
                                    <input type="text" id="contest-name" class="input-field" required>
                                </div>
                                <div>
                                    <label for="contest-place" class="label">Place</label>
                                    <input type="number" id="contest-place" class="input-field" min="1" required>
                                </div>
                                <div>
                                    <label for="contest-type" class="label">Type</label>
                                    <input type="text" id="contest-type" class="input-field" placeholder="Online / On-Site" required>
                                </div>
                                <div>
                                    <label for="contest-date" class="label">Date</label>
                                    <input type="text" id="contest-date" class="input-field" placeholder="DD/MM/YYYY" required>
                                </div>
                                <div>
                                    <label for="contest-rating" class="label">Points</label>
                                    <input type="number" id="contest-rating" class="input-field" step="0.01" required>
                                </div>
                                <div>
                                    <label for="contest-link" class="label">CTFTime Link</label>
                                    <input type="url" id="contest-link" class="input-field" placeholder="https://ctftime.org/..." required>
                                </div>
                                <button type="submit" id="add-contest-btn" class="btn btn-primary w-full">Add Contest</button>
                                <button type="button" id="cancel-edit-contest-btn" class="btn btn-secondary w-full" style="display:none;">Cancel Edit</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Writeups Tab --><div id="tab-writeups" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6 lg:col-span-2">
                            <h2 class="text-2xl font-semibold mb-4 text-white">Current Writeups</h2>
                            <div id="writeups-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                <!-- Writeups will be injected here by JS --></div>
                        </div>
                        <div class="card p-6 lg:col-span-1">
                            <h2 class="text-2xl font-semibold mb-4 text-white">Add/Edit Writeup</h2>
                            <div id="writeup-editing-indicator" class="editing-mode-text" style="display:none;">
                                Editing: <span id="editing-writeup-name"></span>
                            </div>
                            <form id="add-writeup-form" class="space-y-4">
                                <input type="hidden" id="writeup-edit-index">
                                <div>
                                    <label for="writeup-title" class="label">Title</label>
                                    <input type="text" id="writeup-title" class="input-field" required>
                                </div>
                                <div>
                                    <label for="writeup-date" class="label">Date</label>
                                    <input type="text" id="writeup-date" class="input-field" placeholder="July 19, 2025" required>
                                </div>
                                <div>
                                    <label for="writeup-tags" class="label">Tags (comma-separated)</label>
                                    <input type="text" id="writeup-tags" class="input-field" placeholder="Web, Blockchain" required>
                                </div>
                                <div>
                                    <label for="writeup-url" class="label">URL</label>
                                    <input type="url" id="writeup-url" class="input-field" placeholder="https://example.com/..." required>
                                </div>
                                <div>
                                    <label for="writeup-excerpt" class="label">Excerpt</label>
                                    <textarea id="writeup-excerpt" class="input-field" rows="4" required></textarea>
                                </div>
                                <button type="submit" id="add-writeup-btn" class="btn btn-primary w-full">Add Writeup</button>
                                <button type="button" id="cancel-edit-writeup-btn" class="btn btn-secondary w-full" style="display:none;">Cancel Edit</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Gallery Tab --><div id="tab-gallery" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6 lg:col-span-2">
                            <h2 class="text-2xl font-semibold mb-4 text-white">Current Gallery Items</h2>
                            <div id="gallery-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                <!-- Gallery items will be injected here by JS --></div>
                        </div>
                        <div class="card p-6 lg:col-span-1">
                            <h2 class="text-2xl font-semibold mb-4 text-white">Add/Edit Gallery Item</h2>
                            <div id="gallery-editing-indicator" class="editing-mode-text" style="display:none;">
                                Editing: <span id="editing-gallery-name"></span>
                            </div>
                            <form id="add-gallery-form" class="space-y-4">
                                <input type="hidden" id="gallery-edit-index">
                                <div>
                                    <label for="gallery-image" class="label">Image URL</label>
                                    <input type="text" id="gallery-image" class="input-field" placeholder="/images/gallery/foo.jpg" required>
                                </div>
                                <div>
                                    <label for="gallery-caption" class="label">Caption</label>
                                    <input type="text" id="gallery-caption" class="input-field" required>
                                </div>
                                <div>
                                    <label for="gallery-date" class="label">Date</label>
                                    <input type="text" id="gallery-date" class="input-field" placeholder="July 7, 2023" required>
                                </div>
                                <button type="submit" id="add-gallery-btn" class="btn btn-primary w-full">Add Gallery Item</button>
                                <button type="button" id="cancel-edit-gallery-btn" class="btn btn-secondary w-full" style="display:none;">Cancel Edit</button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 3. JavaScript Logic --><script>
        document.addEventListener('DOMContentLoaded', () => {
            let fullData = null; // This will hold our loaded JSON object
            
            // Separate edit indexes for each section
            let currentMemberEditIndex = -1;
            let currentContestEditIndex = -1;
            let currentWriteupEditIndex = -1;
            let currentGalleryEditIndex = -1;

            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const editorArea = document.getElementById('editor-area');
            const downloadBtn = document.getElementById('download-btn');
            const messageBar = document.getElementById('message-bar');
            const tabs = document.getElementById('tabs');

            // --- Member elements ---
            const addMemberForm = document.getElementById('add-member-form');
            const memberNameInput = document.getElementById('member-name');
            const memberAvatarInput = document.getElementById('member-avatar');
            const memberMotoInput = document.getElementById('member-moto');
            const memberTagsInput = document.getElementById('member-tags');
            const memberGithubInput = document.getElementById('member-github');
            const memberFacebookInput = document.getElementById('member-facebook');
            const memberLinkedinInput = document.getElementById('member-linkedin');
            const memberEditIndexInput = document.getElementById('member-edit-index');
            const addMemberBtn = document.getElementById('add-member-btn');
            const cancelEditMemberBtn = document.getElementById('cancel-edit-member-btn');
            const memberEditingIndicator = document.getElementById('member-editing-indicator');
            const editingMemberNameSpan = document.getElementById('editing-member-name');

            // --- Contest elements ---
            const addContestForm = document.getElementById('add-contest-form');
            const contestNameInput = document.getElementById('contest-name');
            const contestPlaceInput = document.getElementById('contest-place');
            const contestTypeInput = document.getElementById('contest-type');
            const contestDateInput = document.getElementById('contest-date');
            const contestRatingInput = document.getElementById('contest-rating');
            const contestLinkInput = document.getElementById('contest-link');
            const contestEditIndexInput = document.getElementById('contest-edit-index');
            const addContestBtn = document.getElementById('add-contest-btn');
            const cancelEditContestBtn = document.getElementById('cancel-edit-contest-btn');
            const contestEditingIndicator = document.getElementById('contest-editing-indicator');
            const editingContestNameSpan = document.getElementById('editing-contest-name');

            // --- Writeup elements ---
            const addWriteupForm = document.getElementById('add-writeup-form');
            const writeupTitleInput = document.getElementById('writeup-title');
            const writeupDateInput = document.getElementById('writeup-date');
            const writeupTagsInput = document.getElementById('writeup-tags');
            const writeupUrlInput = document.getElementById('writeup-url');
            const writeupExcerptInput = document.getElementById('writeup-excerpt');
            const writeupEditIndexInput = document.getElementById('writeup-edit-index');
            const addWriteupBtn = document.getElementById('add-writeup-btn');
            const cancelEditWriteupBtn = document.getElementById('cancel-edit-writeup-btn');
            const writeupEditingIndicator = document.getElementById('writeup-editing-indicator');
            const editingWriteupNameSpan = document.getElementById('editing-writeup-name');

            // --- Gallery elements ---
            const addGalleryForm = document.getElementById('add-gallery-form');
            const galleryImageInput = document.getElementById('gallery-image');
            const galleryCaptionInput = document.getElementById('gallery-caption');
            const galleryDateInput = document.getElementById('gallery-date');
            const galleryEditIndexInput = document.getElementById('gallery-edit-index');
            const addGalleryBtn = document.getElementById('add-gallery-btn');
            const cancelEditGalleryBtn = document.getElementById('cancel-edit-gallery-btn');
            const galleryEditingIndicator = document.getElementById('gallery-editing-indicator');
            const editingGalleryNameSpan = document.getElementById('editing-gallery-name');


            // --- Utility Functions ---
            function showMessage(message, isError = false) {
                messageBar.textContent = message;
                messageBar.style.display = 'block';
                messageBar.style.backgroundColor = isError ? '#dc2626' : '#22c55e'; // red-600 or green-500
                messageBar.style.color = 'white';
                setTimeout(() => { messageBar.style.display = 'none'; }, 3000);
            }

            function parseTags(tagsString) {
                return tagsString.split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);
            }
            function tagsToString(tagsArray) {
                return tagsArray ? tagsArray.join(', ') : '';
            }

            // --- File Loading ---
            function handleFile(file) {
                if (file.type !== 'application/json') {
                    showMessage('Error: File must be a .json file', true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        fullData = JSON.parse(e.target.result);
                        // Ensure arrays exist even if empty
                        fullData.members = fullData.members || [];
                        fullData.contests = fullData.contests || [];
                        fullData.writeups = fullData.writeups || [];
                        fullData.gallery = fullData.gallery || [];

                        dropZone.style.display = 'none';
                        editorArea.style.display = 'block';
                        downloadBtn.style.display = 'block';
                        showMessage('File loaded successfully!', false);
                        renderAll();
                    } catch (err) {
                        showMessage(`Error parsing JSON: ${err.message}`, true);
                        fullData = null;
                    }
                };
                reader.readAsText(file);
            }

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });

            // --- Tab Navigation ---
            tabs.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    // Deactivate all
                    tabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Activate clicked
                    e.target.classList.add('active');
                    document.getElementById(`tab-${e.target.dataset.tab}`).classList.add('active');

                    // Reset all edit modes when changing tabs
                    resetMemberForm();
                    resetContestForm();
                    resetWriteupForm();
                    resetGalleryForm();
                }
            });

            // --- Data Rendering ---
            function renderAll() {
                renderGeneral();
                renderMembers();
                renderContests();
                renderWriteups();
                renderGallery();
            }

            // General
            function renderGeneral() {
                document.getElementById('teamName').value = fullData.teamName || '';
                document.getElementById('flagline').value = fullData.flagline || '';
            }
            document.getElementById('teamName').addEventListener('input', (e) => {
                if (fullData) fullData.teamName = e.target.value;
            });
            document.getElementById('flagline').addEventListener('input', (e) => {
                if (fullData) fullData.flagline = e.target.value;
            });

            // =========================
            // MEMBERS SECTION
            // =========================
            function renderMembers() {
                const list = document.getElementById('members-list');
                list.innerHTML = '';
                if (!fullData.members || fullData.members.length === 0) {
                    list.innerHTML = '<p class="text-gray-400">No members found.</p>';
                    return;
                }
                fullData.members.forEach((member, index) => {
                    const item = document.createElement('div');
                    item.className = 'card p-4 flex justify-between items-center list-item'; 
                    item.dataset.index = index; 
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${member.name}</p>
                            <p class="text-sm text-gray-400">${member.moto}</p>
                        </div>
                        <button class="btn btn-danger delete-btn" data-type="members" data-index="${index}">Delete</button>
                    `;
                    list.appendChild(item);
                });
            }

            function resetMemberForm() {
                addMemberForm.reset();
                memberEditIndexInput.value = '';
                currentMemberEditIndex = -1;
                addMemberBtn.textContent = 'Add Member';
                cancelEditMemberBtn.style.display = 'none';
                memberEditingIndicator.style.display = 'none';
                memberNameInput.focus();
            }

            document.getElementById('members-list').addEventListener('click', (e) => {
                const listItem = e.target.closest('.list-item');
                if (listItem && !e.target.classList.contains('delete-btn')) { 
                    const index = parseInt(listItem.dataset.index, 10);
                    const member = fullData.members[index];

                    if (member) {
                        memberNameInput.value = member.name || '';
                        memberAvatarInput.value = member.avatar || '';
                        memberMotoInput.value = member.moto || '';
                        memberTagsInput.value = tagsToString(member.tags);
                        memberGithubInput.value = member.github || '';
                        memberFacebookInput.value = member.facebook || '';
                        memberLinkedinInput.value = member.linkedin || '';
                        
                        memberEditIndexInput.value = index;
                        currentMemberEditIndex = index;
                        addMemberBtn.textContent = 'Update Member';
                        cancelEditMemberBtn.style.display = 'block';
                        memberEditingIndicator.style.display = 'block';
                        editingMemberNameSpan.textContent = member.name;
                        memberNameInput.focus();
                    }
                }
            });

            addMemberForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newMemberData = {
                    name: memberNameInput.value,
                    avatar: memberAvatarInput.value,
                    moto: memberMotoInput.value,
                    tags: parseTags(memberTagsInput.value),
                    github: memberGithubInput.value,
                    facebook: memberFacebookInput.value,
                    linkedin: memberLinkedinInput.value,
                };

                if (currentMemberEditIndex !== -1) {
                    fullData.members[currentMemberEditIndex] = newMemberData;
                    showMessage('Member updated!', false);
                } else {
                    fullData.members.push(newMemberData);
                    showMessage('Member added!', false);
                }
                
                renderMembers();
                resetMemberForm();
            });

            cancelEditMemberBtn.addEventListener('click', resetMemberForm);

            // =========================
            // CONTESTS SECTION
            // =========================
            function renderContests() {
                const list = document.getElementById('contests-list');
                list.innerHTML = '';
                if (!fullData.contests || fullData.contests.length === 0) {
                    list.innerHTML = '<p class="text-gray-400">No contests found.</p>';
                    return;
                }
                fullData.contests.forEach((contest, index) => {
                    const item = document.createElement('div');
                    item.className = 'card p-4 flex justify-between items-center list-item'; // Added list-item
                    item.dataset.index = index; // Added data-index
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${contest.name} (Place: ${contest.place})</p>
                            <p class="text-sm text-gray-400">${contest.date} - ${contest.type}</p>
                        </div>
                        <button class="btn btn-danger delete-btn" data-type="contests" data-index="${index}">Delete</button>
                    `;
                    list.appendChild(item);
                });
            }

            function resetContestForm() {
                addContestForm.reset();
                contestEditIndexInput.value = '';
                currentContestEditIndex = -1;
                addContestBtn.textContent = 'Add Contest';
                cancelEditContestBtn.style.display = 'none';
                contestEditingIndicator.style.display = 'none';
                contestNameInput.focus();
            }

            document.getElementById('contests-list').addEventListener('click', (e) => {
                const listItem = e.target.closest('.list-item');
                if (listItem && !e.target.classList.contains('delete-btn')) {
                    const index = parseInt(listItem.dataset.index, 10);
                    const contest = fullData.contests[index];

                    if (contest) {
                        contestNameInput.value = contest.name || '';
                        contestPlaceInput.value = contest.place || '';
                        contestTypeInput.value = contest.type || '';
                        contestDateInput.value = contest.date || '';
                        contestRatingInput.value = contest.rating || '';
                        contestLinkInput.value = contest.link || '';
                        
                        contestEditIndexInput.value = index;
                        currentContestEditIndex = index;
                        addContestBtn.textContent = 'Update Contest';
                        cancelEditContestBtn.style.display = 'block';
                        contestEditingIndicator.style.display = 'block';
                        editingContestNameSpan.textContent = contest.name;
                        contestNameInput.focus();
                    }
                }
            });

            addContestForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newContest = {
                    place: parseInt(contestPlaceInput.value, 10),
                    name: contestNameInput.value,
                    type: contestTypeInput.value,
                    date: contestDateInput.value,
                    rating: parseFloat(contestRatingInput.value),
                    link: contestLinkInput.value,
                };
                
                if (currentContestEditIndex !== -1) {
                    fullData.contests[currentContestEditIndex] = newContest;
                    showMessage('Contest updated!', false);
                } else {
                    fullData.contests.push(newContest);
                    showMessage('Contest added!', false);
                }

                renderContests();
                resetContestForm();
            });

            cancelEditContestBtn.addEventListener('click', resetContestForm);

            // =========================
            // WRITEUPS SECTION
            // =========================
            function renderWriteups() {
                const list = document.getElementById('writeups-list');
                list.innerHTML = '';
                if (!fullData.writeups || fullData.writeups.length === 0) {
                    list.innerHTML = '<p class="text-gray-400">No writeups found.</p>';
                    return;
                }
                fullData.writeups.forEach((writeup, index) => {
                    const item = document.createElement('div');
                    item.className = 'card p-4 flex justify-between items-center list-item'; // Added list-item
                    item.dataset.index = index; // Added data-index
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${writeup.title}</p>
                            <p class="text-sm text-gray-400">${writeup.date}</p>
                        </div>
                        <button class="btn btn-danger delete-btn" data-type="writeups" data-index="${index}">Delete</button>
                    `;
                    list.appendChild(item);
                });
            }

            function resetWriteupForm() {
                addWriteupForm.reset();
                writeupEditIndexInput.value = '';
                currentWriteupEditIndex = -1;
                addWriteupBtn.textContent = 'Add Writeup';
                cancelEditWriteupBtn.style.display = 'none';
                writeupEditingIndicator.style.display = 'none';
                writeupTitleInput.focus();
            }

            document.getElementById('writeups-list').addEventListener('click', (e) => {
                const listItem = e.target.closest('.list-item');
                if (listItem && !e.target.classList.contains('delete-btn')) {
                    const index = parseInt(listItem.dataset.index, 10);
                    const writeup = fullData.writeups[index];

                    if (writeup) {
                        writeupTitleInput.value = writeup.title || '';
                        writeupDateInput.value = writeup.date || '';
                        writeupTagsInput.value = tagsToString(writeup.tags);
                        writeupUrlInput.value = writeup.url || '';
                        writeupExcerptInput.value = writeup.excerpt || '';
                        
                        writeupEditIndexInput.value = index;
                        currentWriteupEditIndex = index;
                        addWriteupBtn.textContent = 'Update Writeup';
                        cancelEditWriteupBtn.style.display = 'block';
                        writeupEditingIndicator.style.display = 'block';
                        editingWriteupNameSpan.textContent = writeup.title;
                        writeupTitleInput.focus();
                    }
                }
            });

            addWriteupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newWriteup = {
                    date: writeupDateInput.value,
                    title: writeupTitleInput.value,
                    tags: parseTags(writeupTagsInput.value),
                    excerpt: writeupExcerptInput.value,
                    url: writeupUrlInput.value,
                };
                
                if (currentWriteupEditIndex !== -1) {
                    fullData.writeups[currentWriteupEditIndex] = newWriteup;
                    showMessage('Writeup updated!', false);
                } else {
                    fullData.writeups.push(newWriteup);
                    showMessage('Writeup added!', false);
                }

                renderWriteups();
                resetWriteupForm();
            });
            
            cancelEditWriteupBtn.addEventListener('click', resetWriteupForm);

            // =========================
            // GALLERY SECTION
            // =========================
            function renderGallery() {
                const list = document.getElementById('gallery-list');
                list.innerHTML = '';
                if (!fullData.gallery || fullData.gallery.length === 0) {
                    list.innerHTML = '<p class="text-gray-400">No gallery items found.</p>';
                    return;
                }
                fullData.gallery.forEach((item, index) => {
                    const el = document.createElement('div');
                    el.className = 'card p-4 flex justify-between items-center list-item'; // Added list-item
                    el.dataset.index = index; // Added data-index
                    el.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${item.caption}</p>
                            <p class="text-sm text-gray-400">${item.date}</p>
                        </div>
                        <button class="btn btn-danger delete-btn" data-type="gallery" data-index="${index}">Delete</button>
                    `;
                    list.appendChild(el);
                });
            }

            function resetGalleryForm() {
                addGalleryForm.reset();
                galleryEditIndexInput.value = '';
                currentGalleryEditIndex = -1;
                addGalleryBtn.textContent = 'Add Gallery Item';
                cancelEditGalleryBtn.style.display = 'none';
                galleryEditingIndicator.style.display = 'none';
                galleryImageInput.focus();
            }

            document.getElementById('gallery-list').addEventListener('click', (e) => {
                const listItem = e.target.closest('.list-item');
                if (listItem && !e.target.classList.contains('delete-btn')) {
                    const index = parseInt(listItem.dataset.index, 10);
                    const item = fullData.gallery[index];

                    if (item) {
                        galleryImageInput.value = item.imageUrl || '';
                        galleryCaptionInput.value = item.caption || '';
                        galleryDateInput.value = item.date || '';
                        
                        galleryEditIndexInput.value = index;
                        currentGalleryEditIndex = index;
                        addGalleryBtn.textContent = 'Update Gallery Item';
                        cancelEditGalleryBtn.style.display = 'block';
                        galleryEditingIndicator.style.display = 'block';
                        editingGalleryNameSpan.textContent = item.caption;
                        galleryImageInput.focus();
                    }
                }
            });

            addGalleryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const newItem = {
                    // id is handled below
                    imageUrl: galleryImageInput.value,
                    caption: galleryCaptionInput.value,
                    date: galleryDateInput.value,
                };
                
                if (currentGalleryEditIndex !== -1) {
                    // Preserve existing ID on update
                    newItem.id = fullData.gallery[currentGalleryEditIndex].id; 
                    fullData.gallery[currentGalleryEditIndex] = newItem;
                    showMessage('Gallery item updated!', false);
                } else {
                    // Generate a new ID for new item
                    const newId = fullData.gallery.length > 0 
                        ? Math.max(...fullData.gallery.map(g => g.id)) + 1 
                        : 1;
                    newItem.id = newId;
                    fullData.gallery.push(newItem);
                    showMessage('Gallery item added!', false);
                }

                renderGallery();
                resetGalleryForm();
            });

            cancelEditGalleryBtn.addEventListener('click', resetGalleryForm);

            // --- Generic Delete Handler ---
            editorArea.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const type = e.target.dataset.type;
                    const index = parseInt(e.target.dataset.index, 10);
                    
                    if (fullData[type] && fullData[type][index]) {
                        
                        if (confirm(`Are you sure you want to delete this ${type.slice(0, -1)}?`)) {
                            fullData[type].splice(index, 1);
                            
                            // Re-render and reset the form for the correct type
                            if (type === 'members') {
                                renderMembers();
                                resetMemberForm(); 
                            }
                            else if (type === 'contests') {
                                renderContests();
                                resetContestForm();
                            }
                            else if (type === 'writeups') {
                                renderWriteups();
                                resetWriteupForm();
                            }
                            else if (type === 'gallery') {
                                renderGallery();
                                resetGalleryForm();
                            }
                            
                            showMessage('Item deleted!', false);
                        }
                    }
                }
            });

            // --- File Saving ---
            downloadBtn.addEventListener('click', () => {
                if (!fullData) {
                    showMessage('No data to save', true);
                    return;
                }

                const dataString = JSON.stringify(fullData, null, 2); // Pretty-print JSON
                const blob = new Blob([dataString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('JSON file saved!', false);
            });
        });
    </script>
</body>
</html>

